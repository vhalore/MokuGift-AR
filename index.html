<!DOCTYPE html>
<html>
<head>
    <title>MokuGift AR Experience</title>
    <style>
        body { 
            margin: 0;
            overflow: hidden;
            font-family: Arial;
        }
        #ar-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 30px;
            z-index: 999;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px;
            border-radius: 8px;
            display: none;
            max-width: 80%;
        }
    </style>
    <!-- Three.js Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div id="loading">
        <h2>Loading MokuGift AR</h2>
        <div id="progress" style="width: 200px; height: 20px; background: #333; margin: 20px;">
            <div id="progress-bar" style="height: 100%; width: 0%; background: #4CAF50;"></div>
        </div>
    </div>
    
    <div id="info">Point your camera at a flat surface</div>
    <button id="ar-button">START AR EXPERIENCE</button>

    <script>
        // Global Variables
        let scene, camera, renderer, model;
        let hitTestSource = null;
        let arSession = null;
        
        // DOM Elements
        const arButton = document.getElementById('ar-button');
        const infoDiv = document.getElementById('info');
        const loadingDiv = document.getElementById('loading');
        const progressBar = document.getElementById('progress-bar');
        
        // Initialize
        async function init() {
            // Check WebXR support
            if (!await checkXRSupport()) return;
            
            // Setup Three.js scene
            await initScene();
            
            // Load 3D model
            await loadModel('models/3d.glb');
            
            // Ready to start AR
            loadingDiv.style.display = 'none';
            arButton.style.display = 'block';
        }
        
        // Check WebXR Availability
        async function checkXRSupport() {
            if (!navigator.xr) {
                showError("WebXR not supported in your browser");
                return false;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) {
                    showError("AR not available on this device");
                    return false;
                }
                return true;
            } catch (error) {
                showError("Error checking AR support: " + error.message);
                return false;
            }
        }
        
        // Initialize Three.js Scene
        async function initScene() {
            const canvas = document.createElement('canvas');
            document.body.appendChild(canvas);
            
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true,
                canvas: canvas
            });
            renderer.xr.enabled = true;
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
        }
        
        // Load GLB Model
        async function loadModel(modelPath) {
            return new Promise((resolve) => {
                const loader = new THREE.GLTFLoader();
                
                loader.load(
                    modelPath,
                    (gltf) => {
                        model = gltf.scene;
                        model.visible = false;
                        model.scale.set(0.5, 0.5, 0.5);
                        scene.add(model);
                        resolve();
                    },
                    (xhr) => {
                        const percent = (xhr.loaded / xhr.total) * 100;
                        progressBar.style.width = `${percent}%`;
                    },
                    (error) => {
                        showError("Failed to load model: " + error.message);
                        // Fallback cube
                        const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
                        const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
                        model = new THREE.Mesh(geometry, material);
                        scene.add(model);
                        resolve();
                    }
                );
            });
        }
        
        // Start AR Session
        async function startAR() {
            try {
                arSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                
                arButton.style.display = 'none';
                infoDiv.style.display = 'block';
                
                arSession.addEventListener('end', onSessionEnd);
                
                const refSpace = await arSession.requestReferenceSpace('local');
                
                // Start AR rendering loop
                renderer.xr.setSession(arSession);
                renderer.setAnimationLoop((timestamp, frame) => {
                    if (!frame) return;
                    
                    const referenceSpace = renderer.xr.getReferenceSpace();
                    const pose = frame.getViewerPose(referenceSpace);
                    
                    // Handle hit test
                    if (pose && model) {
                        if (!hitTestSource) {
                            arSession.requestHitTestSource({ space: referenceSpace })
                                .then((source) => { hitTestSource = source; });
                        }
                        
                        if (hitTestSource) {
                            const hitTestResults = frame.getHitTestResults(hitTestSource);
                            if (hitTestResults.length > 0) {
                                const hit = hitTestResults[0];
                                const hitPose = hit.getPose(referenceSpace);
                                
                                model.position.set(
                                    hitPose.transform.position.x,
                                    hitPose.transform.position.y,
                                    hitPose.transform.position.z
                                );
                                
                                // Align model with surface normal
                                model.quaternion.setFromRotationMatrix(
                                    new THREE.Matrix4().fromArray(hitPose.transform.matrix)
                                );
                                
                                model.visible = true;
                            }
                        }
                    }
                    
                    renderer.render(scene, camera);
                });
                
            } catch (error) {
                showError("AR session failed: " + error.message);
            }
        }
        
        // Session End Handler
        function onSessionEnd() {
            renderer.setAnimationLoop(null);
            renderer.xr.setSession(null);
            infoDiv.style.display = 'none';
            arButton.style.display = 'block';
            if (model) model.visible = false;
            hitTestSource = null;
        }
        
        // Error Handling
        function showError(message) {
            loadingDiv.innerHTML = `
                <h2>Error</h2>
                <p>${message}</p>
                <button onclick="window.location.reload()">Try Again</button>
            `;
            console.error(message);
        }
        
        // Event Listeners
        arButton.addEventListener('click', startAR);
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Start the App
        init();
    </script>
</body>
</html>
