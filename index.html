<!DOCTYPE html>
<html>
<head>
  <title>MokuGift AR (Huawei Fix)</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- Use WebARonARCore version for better Huawei support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-cores.js"></script>
  <style>
    #ar-container {
      position: fixed;
      width: 100%;
      height: 100%;
    }
    #error-message {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- AR Container -->
  <div id="ar-container">
    <a-scene 
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      embedded 
      arjs="sourceType: webcam; debugUIEnabled: true; trackingMethod: best;"
    >
      <!-- Hiro Marker with enhanced parameters -->
      <a-marker 
        type="pattern" 
        preset="hiro"
        url="assets/hiro.patt"
        emitevents="true"
        cursor="rayOrigin: mouse"
        raycaster="objects: .clickable"
        registerevents
      >
        <a-entity 
          gltf-model="models/3d.glb"
          scale="0.1 0.1 0.1"
          class="clickable"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
        ></a-entity>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>
  </div>

  <!-- Error Message -->
  <div id="error-message">
    <h3>Marker Not Detected</h3>
    <p>Try these steps:</p>
    <ol>
      <li>Print the <a href="assets/hiro.png" download>Hiro Marker</a> at 100% scale</li>
      <li>Ensure good lighting (avoid glare)</li>
      <li>Hold phone 30-50cm from marker</li>
      <li>Move slowly if using Huawei P40/Mate series</li>
    </ol>
    <button onclick="location.reload()">Retry</button>
  </div>

  <script>
    // Huawei-specific adjustments
    const scene = document.querySelector('a-scene');
    let timeout;
    
    // Show error if no detection after 10 seconds
    scene.addEventListener('loaded', () => {
      timeout = setTimeout(showError, 10000);
    });
    
    // Cancel timeout if marker found
    scene.addEventListener('markerFound', () => {
      clearTimeout(timeout);
      document.getElementById('error-message').style.display = 'none';
    });
    
    function showError() {
      document.getElementById('error-message').style.display = 'block';
    }
    
    // Huawei camera warmup workaround
    if (/huawei/i.test(navigator.userAgent)) {
      setTimeout(() => {
        const camera = document.querySelector('[camera]');
        camera.setAttribute('camera', 'active', false);
        camera.setAttribute('camera', 'active', true);
      }, 1000);
    }
  </script>
</body>
</html>
